// script.js
let words = [];
let stopRequested = false;
let shuffleLoopRunning = false;
let sessionTimeoutId = null;
let wakeLock = null;

// Cache buttons
const startBtn = document.getElementById("startButton");
const stopBtn = document.getElementById("stopButton");

// Load word list
fetch('words.json')
  .then(response => response.json())
  .then(data => {
    words = data.neutral_words;
  });

// Update label when slider changes
const durationSlider = document.getElementById("durationSlider");
const durationLabel = document.getElementById("durationLabel");
durationSlider.addEventListener("input", () => {
  durationLabel.textContent = durationSlider.value;
});

// Start button logic
startBtn.addEventListener("click", () => {
  if (!shuffleLoopRunning) {
    // Toggle buttons
    startBtn.disabled = true;
    stopBtn.disabled = false;

    stopRequested = false;
    shuffleLoopRunning = true;

    const durationMinutes = parseInt(durationSlider.value, 10);
    const durationMs = durationMinutes * 60 * 1000;

    sessionTimeoutId = setTimeout(() => {
      stopShuffle("Session complete.");
    }, durationMs);

    startLoop();
  }
});

// Stop button logic
stopBtn.addEventListener("click", () => {
  stopShuffle("Shuffle stopped.");
});

// Main loop
async function startLoop() {
  if (words.length === 0) {
    alert('Word list not loaded yet!');
    shuffleLoopRunning = false;
    // Reset buttons
    startBtn.disabled = false;
    stopBtn.disabled = true;
    return;
  }

  await requestWakeLock();

  while (!stopRequested) {
    await startShuffle();
    if (stopRequested) break;
    await delay(2000);
  }

  shuffleLoopRunning = false;
}

// Word shuffle routine
async function startShuffle() {
  const word = words[Math.floor(Math.random() * words.length)];
  await speak(`Your word is ${word}`);
  await delay(2000);

  for (let letter of word) {
    if (stopRequested) return;
    const message = `Think of words that start with ${letter.toUpperCase()}`;
    document.getElementById("prompt").textContent = message;
    await speak(message);
    await delay(3000);
  }

  document.getElementById("prompt").textContent = "";
}

// Speech function
function speak(text) {
  return new Promise(resolve => {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.onend = () => resolve();
    speechSynthesis.speak(utterance);
  });
}

// Delay helper
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// Stop handler
async function stopShuffle(message) {
  if (!shuffleLoopRunning && message !== "Session complete.") return;

  stopRequested = true;
  speechSynthesis.cancel();
  clearTimeout(sessionTimeoutId);
  document.getElementById("prompt").textContent = message;
  shuffleLoopRunning = false;

  // Toggle buttons
  startBtn.disabled = false;
  stopBtn.disabled = true;

  // Release wake lock
  if (wakeLock) {
    try {
      await wakeLock.release();
      wakeLock = null;
      console.log("Wake lock released");
    } catch (err) {
      console.warn("Wake lock release failed:", err);
    }
  }

  // Attempt to close window
  window.close();
}

// Wake Lock logic
async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      console.log("Wake lock acquired");
    }
  } catch (err) {
    console.error("Failed to acquire wake lock:", err);
  }
}

document.addEventListener("visibilitychange", async () => {
  if (wakeLock && document.visibilityState === "visible") {
    await requestWakeLock();
  }
});
